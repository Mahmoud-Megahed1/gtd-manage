#!/usr/bin/env pwsh
# Simple Deploy - No fancy stuff, just works!
# ??? ???? - ???? ???????? ??? ????!

$ErrorActionPreference = "Stop"

Write-Host @"

?????????????????????????????????????????????????????????????????
?                  ?? Simple Deploy to Hostinger                ?
?????????????????????????????????????????????????????????????????

"@ -ForegroundColor Cyan

# ?????? 1: ??? ????????
Write-Host "?? ???? ????? ?????? Hostinger:`n" -ForegroundColor Yellow

$host_ssh = Read-Host "SSH Host (????: srv123.hostinger.com)"
$host_user = Read-Host "SSH Username (????: u123456789)"
$host_port = Read-Host "SSH Port (???? Enter ?????????: 65002)"
if (!$host_port) { $host_port = "65002" }

$domain = Read-Host "Domain Name (????: gtd-sys.com)"
$target = "/home/$host_user/domains/$domain/public_html"
Write-Host "Target Path: $target" -ForegroundColor Gray

Write-Host "`n?? ?????? Database:`n" -ForegroundColor Yellow
$db_name = Read-Host "Database Name"
$db_user = Read-Host "Database User"
$db_pass = Read-Host "Database Password" -AsSecureString
$db_pass_plain = [Runtime.InteropServices.Marshal]::PtrToStringAuto(
    [Runtime.InteropServices.Marshal]::SecureStringToBSTR($db_pass)
)

# ????? COOKIE_SECRET
$cookie_secret = -join ((1..48) | ForEach-Object { [char](Get-Random -Min 33 -Max 126) })

# ?????? 2: Build
Write-Host "`n??  ???? ???????..." -ForegroundColor Yellow
pnpm run build
if ($LASTEXITCODE -ne 0) {
    Write-Host "? ??? ??????!" -ForegroundColor Red
    exit 1
}
Write-Host "? ?? ??????" -ForegroundColor Green

# ?????? 3: ????? ???????
Write-Host "`n?? ????? ???????..." -ForegroundColor Yellow
$temp = "deploy-pkg"
if (Test-Path $temp) { Remove-Item $temp -Recurse -Force }
New-Item $temp -ItemType Directory | Out-Null

Copy-Item "dist" "$temp\dist" -Recurse
Copy-Item "package.json" "$temp\"
if (Test-Path "pnpm-lock.yaml") { Copy-Item "pnpm-lock.yaml" "$temp\" }

# ????? .env
@"
NODE_ENV=production
PORT=3000
COOKIE_SECRET=$cookie_secret
WEB_ORIGIN=https://$domain
VITE_SERVER_ORIGIN=https://$domain
DATABASE_URL=mysql://${db_user}:${db_pass_plain}@localhost:3306/$db_name
VITE_APP_ID=gtd-prod
VITE_USE_DEV_LOGIN=false
VITE_ANALYTICS_ENDPOINT=
VITE_ANALYTICS_WEBSITE_ID=
"@ | Set-Content "$temp\.env"

Write-Host "? ??????? ?????" -ForegroundColor Green

# ?????? 4: ?????? SSH
Write-Host "`n?? ?????? SSH..." -ForegroundColor Yellow
$ssh_key = ".ssh\id_ed25519"

if (!(Test-Path $ssh_key)) {
    Write-Host "? SSH Key ??? ?????!" -ForegroundColor Red
    Write-Host "   ????: ssh-keygen -t ed25519 -f $ssh_key" -ForegroundColor Yellow
    exit 1
}

$test = ssh -i $ssh_key -p $host_port -o ConnectTimeout=10 ${host_user}@${host_ssh} "echo OK" 2>&1
if ($LASTEXITCODE -ne 0) {
    Write-Host "? ??? SSH!" -ForegroundColor Red
    Write-Host "   ???? ?? ????? SSH Public Key ?? Hostinger" -ForegroundColor Yellow
    exit 1
}
Write-Host "? SSH ????" -ForegroundColor Green

# ?????? 5: ?????
Write-Host "`n?? ??? ???????..." -ForegroundColor Yellow
ssh -i $ssh_key -p $host_port ${host_user}@${host_ssh} "mkdir -p $target"
scp -i $ssh_key -P $host_port -r "$temp/*" ${host_user}@${host_ssh}:$target/

if ($LASTEXITCODE -ne 0) {
    Write-Host "? ??? ?????!" -ForegroundColor Red
    exit 1
}
Write-Host "? ?? ?????" -ForegroundColor Green

# ?????? 6: ?????
Write-Host "`n?? ????? ???????..." -ForegroundColor Yellow
ssh -i $ssh_key -p $host_port ${host_user}@${host_ssh} @"
cd $target
npm install --production --silent
npx pm2 delete gtd-sys 2>/dev/null || true
NODE_ENV=production npx pm2 start dist/index.js --name gtd-sys
npx pm2 save
npx pm2 list
"@

Write-Host "? ??????? ????!" -ForegroundColor Green

# ?????? 7: ??????
Write-Host "`n?? ?????? ??????..." -ForegroundColor Yellow
Start-Sleep 5

try {
    $res = Invoke-WebRequest "https://$domain/healthz" -TimeoutSec 10
    if ($res.StatusCode -eq 200) {
        Write-Host "? ?????? ????!" -ForegroundColor Green
    }
} catch {
    Write-Host "??  ?? ??? ??????? - ??? ??????" -ForegroundColor Yellow
}

# ?????
Remove-Item $temp -Recurse -Force

# ???????
Write-Host @"

?????????????????????????????????????????????????????????????????
?                     ? ?? ????? ?????!                       ?
?????????????????????????????????????????????????????????????????

?? ??????: https://$domain
?? Health: https://$domain/healthz

?? ????? ?????:
   ssh -i $ssh_key -p $host_port ${host_user}@${host_ssh}
   npx pm2 logs gtd-sys
   npx pm2 restart gtd-sys

"@ -ForegroundColor Green
