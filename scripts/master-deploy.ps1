#!/usr/bin/env pwsh
# Master Deployment Script - One Command Deploy
# ?????? ????? ??????? - ??? ???? ????

param(
    [switch]$Setup,      # ????? ???? ???
    [switch]$Deploy,     # ??? ??? (???? ?????)
    [switch]$SkipBuild,  # ???? ??????
    [switch]$CheckOnly,  # ??? ???????? ???
    [switch]$Help        # ??? ????????
)

$ErrorActionPreference = "Stop"

# ============================================================================
# HELP
# ============================================================================

if ($Help) {
    Write-Host @"

?????????????????????????????????????????????????????????????????
?                                                               ?
?           ?? GTD System - Master Deploy Script               ?
?                                                               ?
?????????????????????????????????????????????????????????????????

?????????:
  .\scripts\master-deploy.ps1 [OPTIONS]

????????:
  (???? ??????)    ??? ???? (????? + ???)
  -Setup            ????? ???? ??? (SSH, Database, Config)
  -Deploy           ??? ??? (?????? ??????? ??????)
  -SkipBuild        ???? ???? ???????
  -CheckOnly        ??? ???????? ???
  -Help             ??? ??? ????????

?????:
  # ??? ???? ?? ????? (??? ???)
  .\scripts\master-deploy.ps1

  # ????? ??? (??? ????????)
  .\scripts\master-deploy.ps1 -Setup

  # ??? ??? (???????? ??????? ??????)
  .\scripts\master-deploy.ps1 -Deploy

  # ??? ????????
  .\scripts\master-deploy.ps1 -CheckOnly

  # ??? ???? ???? (??? ??? Build ?????)
  .\scripts\master-deploy.ps1 -Deploy -SkipBuild

?????????? ????????:
  ? scripts/check-deploy-ready.ps1    ??? ????????
  ? scripts/setup-database.ps1        ????? Database
  ? scripts/auto-deploy.ps1           ??? ?????? ????
  ? scripts/master-deploy.ps1         ??? ???????? (???????)

"@
    exit 0
}

# ============================================================================
# BANNER
# ============================================================================

Write-Host @"

?????????????????????????????????????????????????????????????????
?                                                               ?
?              ?? GTD System - Master Deploy                    ?
?                   ??? ???? ???? ????                         ?
?                                                               ?
?????????????????????????????????????????????????????????????????

"@ -ForegroundColor Cyan

# ============================================================================
# CHECK READINESS
# ============================================================================

if ($CheckOnly) {
    Write-Host "? ??? ????????..." -ForegroundColor Magenta
    Write-Host ""
    
    if (Test-Path "scripts\check-deploy-ready.ps1") {
        & ".\scripts\check-deploy-ready.ps1"
    } else {
        Write-Host "? scripts\check-deploy-ready.ps1 ??? ?????!" -ForegroundColor Red
    }
    
    exit 0
}

# ============================================================================
# SETUP MODE
# ============================================================================

if ($Setup) {
    Write-Host "? ??? ??????? - ??? ???????? ??????" -ForegroundColor Magenta
    Write-Host ""
    
    # Run database setup
    Write-Host "???????????????????????????????????????????????????????????????" -ForegroundColor Gray
    Write-Host "?? ????? Database" -ForegroundColor Yellow
    Write-Host "???????????????????????????????????????????????????????????????" -ForegroundColor Gray
    
    if (Test-Path "scripts\setup-database.ps1") {
        & ".\scripts\setup-database.ps1"
    } else {
        Write-Host "? scripts\setup-database.ps1 ??? ?????!" -ForegroundColor Red
    }
    
    # Collect deployment config
    Write-Host ""
    Write-Host "???????????????????????????????????????????????????????????????" -ForegroundColor Gray
    Write-Host "?? ????? Deployment" -ForegroundColor Yellow
    Write-Host "???????????????????????????????????????????????????????????????" -ForegroundColor Gray
    Write-Host ""
    Write-Host "???? ????? ?????? Hostinger:" -ForegroundColor White
    Write-Host ""
    
    $config = @{}
    $config.HostingerHost = Read-Host "SSH Host (????: srv123.hostinger.com)"
    $config.HostingerUser = Read-Host "SSH Username (????: u123456789)"
    $config.HostingerPort = Read-Host "SSH Port (???? Enter ?????????: 65002)"
    if ([string]::IsNullOrWhiteSpace($config.HostingerPort)) { $config.HostingerPort = "65002" }
    
    $config.Domain = Read-Host "Domain Name (????: gtd-sys.com)"
    
    $defaultPath = "/home/$($config.HostingerUser)/domains/$($config.Domain)/public_html"
    $config.TargetPath = Read-Host "Target Path (???? Enter ?????????: $defaultPath)"
    if ([string]::IsNullOrWhiteSpace($config.TargetPath)) { $config.TargetPath = $defaultPath }
    
    # Load DB config if exists
    if (Test-Path ".db-connection-info.txt") {
        Write-Host ""
        Write-Host "? ?? ?????? ??? ?????? Database ?? ?????? ???????" -ForegroundColor Green
        
        $dbInfo = Get-Content ".db-connection-info.txt" | Select-String "Database:|Username:|Password:"
        $config.DbName = ($dbInfo | Select-String "Database:").Line -replace "Database: ", ""
        $config.DbUser = ($dbInfo | Select-String "Username:").Line -replace "Username: ", ""
        $config.DbPass = ($dbInfo | Select-String "Password:").Line -replace "Password: ", ""
    } else {
        Write-Host ""
        Write-Host "???? ????? ?????? Database:" -ForegroundColor White
        $config.DbName = Read-Host "Database Name"
        $config.DbUser = Read-Host "Database User"
        $securePass = Read-Host "Database Password" -AsSecureString
        $config.DbPass = [Runtime.InteropServices.Marshal]::PtrToStringAuto(
            [Runtime.InteropServices.Marshal]::SecureStringToBSTR($securePass)
        )
    }
    
    # Generate COOKIE_SECRET
    $config.CookieSecret = -join ((1..48) | ForEach-Object { 
        [char](Get-Random -Minimum 33 -Maximum 126) 
    })
    
    # Save config
    $config | ConvertTo-Json | Set-Content ".deploy-config.json"
    
    Write-Host ""
    Write-Host "? ?? ??? ????????? ?? .deploy-config.json" -ForegroundColor Green
    Write-Host ""
    Write-Host "???????????????????????????????????????????????????????????????" -ForegroundColor Gray
    Write-Host ""
    Write-Host "? ??????? ?????!" -ForegroundColor Green
    Write-Host ""
    Write-Host "?????? ???????:" -ForegroundColor Yellow
    Write-Host "   .\scripts\master-deploy.ps1 -Deploy" -ForegroundColor Cyan
    Write-Host ""
    
    exit 0
}

# ============================================================================
# DEPLOY MODE
# ============================================================================

if ($Deploy) {
    Write-Host "? ??? ????? - ??????? ??????? ??????" -ForegroundColor Magenta
    Write-Host ""
    
    # Check if config exists
    if (-not (Test-Path ".deploy-config.json")) {
        Write-Host "? ??? .deploy-config.json ??? ?????!" -ForegroundColor Red
        Write-Host ""
        Write-Host "???? ????? ??????? ?????:" -ForegroundColor Yellow
        Write-Host "   .\scripts\master-deploy.ps1 -Setup" -ForegroundColor Cyan
        Write-Host ""
        exit 1
    }
    
    # Run auto-deploy
    if (Test-Path "scripts\auto-deploy.ps1") {
        $params = @{}
        if ($SkipBuild) { $params.SkipBuild = $true }
        
        & ".\scripts\auto-deploy.ps1" @params
    } else {
        Write-Host "? scripts\auto-deploy.ps1 ??? ?????!" -ForegroundColor Red
    }
    
    exit 0
}

# ============================================================================
# FULL DEPLOY (DEFAULT)
# ============================================================================

Write-Host "? ??? ???? (????? + ???)" -ForegroundColor Magenta
Write-Host ""

# Step 1: Check readiness
Write-Host "???????????????????????????????????????????????????????????????" -ForegroundColor Gray
Write-Host "1??  ??? ????????" -ForegroundColor Yellow
Write-Host "???????????????????????????????????????????????????????????????" -ForegroundColor Gray
Write-Host ""

if (Test-Path "scripts\check-deploy-ready.ps1") {
    & ".\scripts\check-deploy-ready.ps1"
} else {
    Write-Host "??  check-deploy-ready.ps1 ??? ????? - ???? ?????" -ForegroundColor Yellow
}

Write-Host ""
$continue = Read-Host "?? ???? ????????? (y/n)"
if ($continue -ne "y") {
    Write-Host "?? ???????" -ForegroundColor Yellow
    exit 0
}

# Step 2: Setup if needed
if (-not (Test-Path ".deploy-config.json")) {
    Write-Host ""
    Write-Host "???????????????????????????????????????????????????????????????" -ForegroundColor Gray
    Write-Host "2??  ??????? ??????" -ForegroundColor Yellow
    Write-Host "???????????????????????????????????????????????????????????????" -ForegroundColor Gray
    
    & $PSCommandPath -Setup
    
    Write-Host ""
    Write-Host "? ??????? ?????" -ForegroundColor Green
} else {
    Write-Host ""
    Write-Host "? ??????? ????? - ??????? .deploy-config.json" -ForegroundColor Green
}

# Step 3: Deploy
Write-Host ""
Write-Host "???????????????????????????????????????????????????????????????" -ForegroundColor Gray
Write-Host "3??  ????? ??? Hostinger" -ForegroundColor Yellow
Write-Host "???????????????????????????????????????????????????????????????" -ForegroundColor Gray
Write-Host ""

$params = @{}
if ($SkipBuild) { $params.SkipBuild = $true }

if (Test-Path "scripts\auto-deploy.ps1") {
    & ".\scripts\auto-deploy.ps1" @params
} else {
    Write-Host "? scripts\auto-deploy.ps1 ??? ?????!" -ForegroundColor Red
    exit 1
}

Write-Host ""
Write-Host "?????????????????????????????????????????????????????????????????" -ForegroundColor Green
Write-Host "?                                                               ?" -ForegroundColor Green
Write-Host "?              ? ????? ?????? ?????!                          ?" -ForegroundColor Green
Write-Host "?                                                               ?" -ForegroundColor Green
Write-Host "?????????????????????????????????????????????????????????????????" -ForegroundColor Green
Write-Host ""
