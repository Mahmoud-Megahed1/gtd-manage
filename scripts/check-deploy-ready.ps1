#!/usr/bin/env pwsh
# Quick Deploy Check Script
# ???? ???? ??? ?????

$ErrorActionPreference = "Stop"

Write-Host "`n?? ??? ?????? ??????? ?????...`n" -ForegroundColor Cyan

$allGood = $true

# Check 1: Build output
Write-Host "? ??? ????? Build..." -ForegroundColor Yellow
if (Test-Path "dist/index.js") {
    $size = (Get-Item "dist/index.js").Length / 1MB
    Write-Host "  ? dist/index.js ????? ($([Math]::Round($size, 2)) MB)" -ForegroundColor Green
} else {
    Write-Host "  ? dist/index.js ??? ????? - ???: pnpm run build" -ForegroundColor Red
    $allGood = $false
}

if (Test-Path "dist/public") {
    $files = (Get-ChildItem "dist/public" -Recurse -File).Count
    Write-Host "  ? dist/public/ ????? ($files ???)" -ForegroundColor Green
} else {
    Write-Host "  ? dist/public/ ??? ?????" -ForegroundColor Red
    $allGood = $false
}

# Check 2: Dependencies
Write-Host "`n? ??? Dependencies..." -ForegroundColor Yellow
if (Test-Path "node_modules") {
    Write-Host "  ? node_modules/ ?????" -ForegroundColor Green
} else {
    Write-Host "  ? node_modules/ ??? ????? - ???: pnpm install" -ForegroundColor Red
    $allGood = $false
}

# Check 3: SSH Key
Write-Host "`n? ??? SSH Key..." -ForegroundColor Yellow
if (Test-Path ".ssh/id_ed25519") {
    Write-Host "  ? SSH Private Key ?????" -ForegroundColor Green
} else {
    Write-Host "  ??  SSH Key ??? ????? - ???? ?????? ????????" -ForegroundColor Yellow
    Write-Host "     ???: ssh-keygen -t ed25519 -f .ssh/id_ed25519 -C 'hostinger'" -ForegroundColor Gray
}

if (Test-Path ".ssh/id_ed25519.pub") {
    Write-Host "  ? SSH Public Key ?????" -ForegroundColor Green
} else {
    Write-Host "  ??  SSH Public Key ??? ?????" -ForegroundColor Yellow
}

# Check 4: Configuration files
Write-Host "`n? ??? ????? ???????..." -ForegroundColor Yellow
if (Test-Path "package.json") {
    Write-Host "  ? package.json ?????" -ForegroundColor Green
} else {
    Write-Host "  ? package.json ??? ?????" -ForegroundColor Red
    $allGood = $false
}

if (Test-Path ".env.production.template") {
    Write-Host "  ? .env.production.template ?????" -ForegroundColor Green
} else {
    Write-Host "  ??  .env.production.template ??? ?????" -ForegroundColor Yellow
}

# Check 5: Server files
Write-Host "`n? ??? Server files..." -ForegroundColor Yellow
$serverFiles = @(
    "server\_core\app.ts",
    "server\_core\index.ts",
    "server\_core\env.ts",
    "server\_core\cookies.ts"
)

foreach ($file in $serverFiles) {
    if (Test-Path $file) {
        Write-Host "  ? $file" -ForegroundColor Green
    } else {
        Write-Host "  ? $file ??? ?????" -ForegroundColor Red
        $allGood = $false
    }
}

# Check 6: Deploy scripts
Write-Host "`n? ??? Deploy scripts..." -ForegroundColor Yellow
if (Test-Path "scripts/deploy-now.ps1") {
    Write-Host "  ? deploy-now.ps1 ?????" -ForegroundColor Green
} else {
    Write-Host "  ? deploy-now.ps1 ??? ?????" -ForegroundColor Red
    $allGood = $false
}

# Summary
Write-Host "`n" -NoNewline
Write-Host "???????????????????????????????????????????" -ForegroundColor Cyan

if ($allGood) {
    Write-Host "? ??????? ???? 100% ?????!" -ForegroundColor Green
    Write-Host "???????????????????????????????????????????" -ForegroundColor Cyan
    Write-Host ""
    Write-Host "?? ????? ??? Hostinger? ??? ?????:" -ForegroundColor White
    Write-Host "   .\scripts\deploy-now.ps1" -ForegroundColor Cyan
    Write-Host ""
    Write-Host "?? ?? ???? ?????? ??????:" -ForegroundColor White
    Write-Host "   code FINAL-DEPLOY-GUIDE.md" -ForegroundColor Cyan
    Write-Host ""
    Write-Host "?? ?????? Hostinger:" -ForegroundColor White
    Write-Host "   https://hpanel.hostinger.com" -ForegroundColor Gray
    Write-Host "   almalkalhzen@gmail.com" -ForegroundColor Gray
    Write-Host ""
} else {
    Write-Host "??  ??????? ????? ??? ?????????" -ForegroundColor Yellow
    Write-Host "???????????????????????????????????????????" -ForegroundColor Cyan
    Write-Host ""
    Write-Host "?? ???? ??????? ????? ?? ??? ????????" -ForegroundColor White
    Write-Host ""
    exit 1
}

# Show Hostinger requirements
Write-Host "?? ??????? Hostinger:" -ForegroundColor Yellow
Write-Host "   • Cloud Startup (?? ????) - ???? Node.js ?" -ForegroundColor White
Write-Host "   • MySQL Database ?" -ForegroundColor White
Write-Host "   • SSH Access ?" -ForegroundColor White
Write-Host "   • SSL Certificate (?????? ????????) ?" -ForegroundColor White
Write-Host ""

# Quick commands reference
Write-Host "?? ????? ?????:" -ForegroundColor Yellow
Write-Host "   • Build ???????:     pnpm run build" -ForegroundColor Gray
Write-Host "   • Test ????:         pnpm run dev" -ForegroundColor Gray
Write-Host "   • Deploy:            .\scripts\deploy-now.ps1" -ForegroundColor Gray
Write-Host "   • ????? SSH Key:    ssh-keygen -t ed25519 -f .ssh/id_ed25519" -ForegroundColor Gray
Write-Host ""
