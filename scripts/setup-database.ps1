#!/usr/bin/env pwsh
# Setup Hostinger MySQL Database Automatically
# ????? ????? ?????? MySQL ??? Hostinger ????????

param(
    [string]$DbHost = "localhost",
    [string]$DbName = "",
    [string]$DbUser = "",
    [string]$DbPass = ""
)

$ErrorActionPreference = "Stop"

Write-Host @"

?????????????????????????????????????????????????????????????????
?                                                               ?
?          ???  Hostinger MySQL Database Setup                  ?
?                                                               ?
?????????????????????????????????????????????????????????????????

"@ -ForegroundColor Cyan

# Load configuration if exists
$configFile = ".deploy-config.json"
if (Test-Path $configFile) {
    $config = Get-Content $configFile | ConvertFrom-Json -AsHashtable
    if (-not $DbName -and $config.DbName) { $DbName = $config.DbName }
    if (-not $DbUser -and $config.DbUser) { $DbUser = $config.DbUser }
    if (-not $DbPass -and $config.DbPass) { $DbPass = $config.DbPass }
}

# Get database credentials
if (-not $DbName) {
    Write-Host "`n?? ???? ????? ?????? Database:" -ForegroundColor Yellow
    $DbName = Read-Host "`nDatabase Name"
}
if (-not $DbUser) {
    $DbUser = Read-Host "Database User"
}
if (-not $DbPass) {
    $securePass = Read-Host "Database Password" -AsSecureString
    $DbPass = [Runtime.InteropServices.Marshal]::PtrToStringAuto(
        [Runtime.InteropServices.Marshal]::SecureStringToBSTR($securePass)
    )
}

Write-Host "`n? ?????? ??????? ?? Database..." -ForegroundColor Magenta

# Test connection (requires mysql client)
$mysqlTest = "mysql -h $DbHost -u $DbUser -p'$DbPass' -e 'SELECT 1;' 2>&1"

try {
    $result = Invoke-Expression $mysqlTest
    if ($LASTEXITCODE -eq 0) {
        Write-Host "? ??????? ?? Database ????!" -ForegroundColor Green
    } else {
        throw "Connection failed"
    }
} catch {
    Write-Host "??  ?????: ?? ???? ?????? ??????? (mysql client ??? ????)" -ForegroundColor Yellow
    Write-Host "   ???? ??????? ???????? ??? ??..." -ForegroundColor Gray
}

# Check if drizzle schema exists
Write-Host "`n? ????? ?? Schema..." -ForegroundColor Magenta

if (Test-Path "drizzle") {
    Write-Host "? ??? ??? ???? drizzle/" -ForegroundColor Green
    
    # Check for migrations
    $migrations = Get-ChildItem "drizzle/*.sql" -ErrorAction SilentlyContinue
    if ($migrations) {
        Write-Host "? ??? ??? $($migrations.Count) migration(s)" -ForegroundColor Green
        
        Write-Host "`n?? Migrations:" -ForegroundColor Yellow
        $migrations | ForEach-Object {
            Write-Host "   • $($_.Name)" -ForegroundColor Gray
        }
        
        Write-Host "`n??  ??????: ??? ????? Migrations ??????:" -ForegroundColor Yellow
        Write-Host ""
        Write-Host "   ??????? 1: ??? Drizzle Kit" -ForegroundColor White
        Write-Host "   pnpm drizzle-kit push:mysql" -ForegroundColor Cyan
        Write-Host ""
        Write-Host "   ??????? 2: ?????? ??? SSH" -ForegroundColor White
        Write-Host "   ssh user@host" -ForegroundColor Cyan
        Write-Host "   cd /path/to/app" -ForegroundColor Cyan
        Write-Host "   npx drizzle-kit push:mysql" -ForegroundColor Cyan
        Write-Host ""
        Write-Host "   ??????? 3: ??? phpMyAdmin ?? Hostinger" -ForegroundColor White
        Write-Host "   - ???? phpMyAdmin ?? Hostinger Panel" -ForegroundColor Gray
        Write-Host "   - ???? Database" -ForegroundColor Gray
        Write-Host "   - ???? ??? SQL tab" -ForegroundColor Gray
        Write-Host "   - ???? ????? ????? .sql" -ForegroundColor Gray
        Write-Host ""
    } else {
        Write-Host "??  ?? ???? ????? migration" -ForegroundColor Yellow
    }
} else {
    Write-Host "??  ???? drizzle/ ??? ?????" -ForegroundColor Yellow
}

# Create connection info file
Write-Host "`n? ????? ??? ??????? ???????..." -ForegroundColor Magenta

$connectionInfo = @"
# MySQL Database Connection Info
# Generated: $(Get-Date -Format "yyyy-MM-dd HH:mm:ss")

Host: $DbHost
Port: 3306
Database: $DbName
Username: $DbUser
Password: $DbPass

# Connection String
DATABASE_URL=mysql://$DbUser:$DbPass@$DbHost:3306/$DbName

# For phpMyAdmin
phpMyAdmin URL: https://hpanel.hostinger.com (Login > Advanced > phpMyAdmin)

# Test Connection
mysql -h $DbHost -u $DbUser -p'$DbPass' $DbName

# Drizzle Push
DATABASE_URL=mysql://$DbUser:$DbPass@$DbHost:3306/$DbName npx drizzle-kit push:mysql
"@

Set-Content -Path ".db-connection-info.txt" -Value $connectionInfo -Encoding UTF8
Write-Host "? ?? ??? ????????? ??: .db-connection-info.txt" -ForegroundColor Green

# Summary
Write-Host "`n"
Write-Host "?????????????????????????????????????????????????????????????????" -ForegroundColor Green
Write-Host "?                                                               ?" -ForegroundColor Green
Write-Host "?              ? Database Setup Complete                       ?" -ForegroundColor Green
Write-Host "?                                                               ?" -ForegroundColor Green
Write-Host "?????????????????????????????????????????????????????????????????" -ForegroundColor Green
Write-Host ""
Write-Host "?? Database Info:" -ForegroundColor Yellow
Write-Host "   Host: $DbHost" -ForegroundColor White
Write-Host "   Database: $DbName" -ForegroundColor White
Write-Host "   Username: $DbUser" -ForegroundColor White
Write-Host "   Password: ********" -ForegroundColor White
Write-Host ""
Write-Host "?? Connection String:" -ForegroundColor Yellow
Write-Host "   mysql://$DbUser:$DbPass@$DbHost:3306/$DbName" -ForegroundColor Cyan
Write-Host ""
Write-Host "???????????????????????????????????????????????????????????????" -ForegroundColor Gray
Write-Host ""
Write-Host "?? ?????? ???????:" -ForegroundColor Yellow
Write-Host ""
Write-Host "   1??  ????? Schema ??? Database:" -ForegroundColor White
Write-Host ""
Write-Host "      # ??? Drizzle Kit (???? ??):" -ForegroundColor Gray
Write-Host "      `$env:DATABASE_URL='mysql://$DbUser:$DbPass@$DbHost:3306/$DbName'" -ForegroundColor Cyan
Write-Host "      pnpm drizzle-kit push:mysql" -ForegroundColor Cyan
Write-Host ""
Write-Host "   2??  ?? ??? phpMyAdmin:" -ForegroundColor White
Write-Host "      - ????: https://hpanel.hostinger.com" -ForegroundColor Gray
Write-Host "      - Advanced > phpMyAdmin" -ForegroundColor Gray
Write-Host "      - SQL tab > ???? ????? drizzle/*.sql" -ForegroundColor Gray
Write-Host ""
Write-Host "???????????????????????????????????????????????????????????????" -ForegroundColor Gray
Write-Host ""
Write-Host "??  ????? .db-connection-info.txt ????? ??? ??????? ?????" -ForegroundColor Red
Write-Host "   ?? ????? ??? Git!" -ForegroundColor Yellow
Write-Host ""
