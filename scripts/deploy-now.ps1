# Hostinger Deployment - Interactive Setup
# ????? ??? Hostinger - ????? ??????

param(
    [switch]$SkipBuild,
    [switch]$TestOnly
)

$ErrorActionPreference = "Stop"

Write-Host "`n" -NoNewline
Write-Host "???????????????????????????????????????????????????????" -ForegroundColor Cyan
Write-Host "  ?? GTD System - Hostinger Deployment" -ForegroundColor Green
Write-Host "???????????????????????????????????????????????????????" -ForegroundColor Cyan
Write-Host ""

# Check if .env.hostinger exists
$envFile = ".env.hostinger"
$needsSetup = -not (Test-Path $envFile)

if ($needsSetup) {
    Write-Host "?? ????? ??? ??? - ?????? ??????? Hostinger" -ForegroundColor Yellow
    Write-Host "?????????????????????????????????????????????????????`n" -ForegroundColor DarkGray
    
    Write-Host "?? ???? 1: ??????? SSH" -ForegroundColor Cyan
    Write-Host "   (???? ????? ??: Hostinger Panel > Advanced > SSH Access)`n" -ForegroundColor DarkGray
    
    $host_ssh = Read-Host "   SSH Host (????: srv123.hostinger.com)"
    $host_user = Read-Host "   SSH Username (????: u123456789)"
    $host_port = Read-Host "   SSH Port (????? ?????? ????????? 65002)"
    if ([string]::IsNullOrWhiteSpace($host_port)) { $host_port = "65002" }
    
    Write-Host "`n?? ???? 2: Domain & Path" -ForegroundColor Cyan
    $domain = Read-Host "   Domain Name (????: gtd-sys.com ?? demo.gtd-sys.com)"
    $host_path = Read-Host "   Target Path (????: /home/u123456789/domains/$domain/public_html)"
    
    Write-Host "`n???  ???? 3: MySQL Database" -ForegroundColor Cyan
    Write-Host "   (???? Database ??: Hostinger Panel > Databases > MySQL)`n" -ForegroundColor DarkGray
    
    $db_name = Read-Host "   Database Name"
    $db_user = Read-Host "   Database User"
    $db_pass = Read-Host "   Database Password" -AsSecureString
    $db_pass_plain = [Runtime.InteropServices.Marshal]::PtrToStringAuto(
        [Runtime.InteropServices.Marshal]::SecureStringToBSTR($db_pass)
    )
    
    Write-Host "`n?? ???? 4: OAuth Settings (??????? - ???? Enter ??????)" -ForegroundColor Cyan
    $oauth_url = Read-Host "   OAuth Server URL"
    $oauth_portal = Read-Host "   OAuth Portal URL"
    $app_id = Read-Host "   App ID"
    
    # Generate strong COOKIE_SECRET
    $cookie_secret = -join ((1..48) | ForEach-Object { 
        [char](Get-Random -Minimum 33 -Maximum 126) 
    })
    
    # Create .env.hostinger
    $envContent = @"
# Hostinger Connection
HOSTINGER_HOST=$host_ssh
HOSTINGER_USER=$host_user
HOSTINGER_PORT=$host_port
HOSTINGER_TARGET=$host_path
HOSTINGER_DOMAIN=$domain

# Production Environment
NODE_ENV=production
PORT=3000
COOKIE_SECRET=$cookie_secret
WEB_ORIGIN=https://$domain
VITE_SERVER_ORIGIN=https://$domain
DATABASE_URL=mysql://${db_user}:${db_pass_plain}@localhost:3306/$db_name
OAUTH_SERVER_URL=$oauth_url
VITE_OAUTH_PORTAL_URL=$oauth_portal
VITE_APP_ID=$app_id
VITE_USE_DEV_LOGIN=false
OWNER_OPEN_ID=
ALLOW_AUTO_PROVISION=false
"@
    
    Set-Content -Path $envFile -Value $envContent -Encoding UTF8
    Write-Host "`n? ?? ??? ????????? ?? .env.hostinger" -ForegroundColor Green
    Write-Host "??  ??? ????? ????? ??? ?????? ????? - ?? ????? ??? Git!`n" -ForegroundColor Yellow
    
    # Show SSH public key
    Write-Host "?????????????????????????????????????????????????????" -ForegroundColor DarkGray
    Write-Host "?? ??????? ????? SSH (???? ?? Hostinger):" -ForegroundColor Cyan
    Write-Host "   Hostinger Panel > Advanced > SSH Keys > Add New Key`n" -ForegroundColor DarkGray
    
    if (Test-Path ".ssh\id_ed25519.pub") {
        Get-Content ".ssh\id_ed25519.pub"
    } else {
        Write-Host "   ? ?? ??? ?????? ??? ????? SSH!" -ForegroundColor Red
        Write-Host "   ?? ???????: ssh-keygen -t ed25519 -f .ssh/id_ed25519 -C 'hostinger-deploy'`n" -ForegroundColor Yellow
        exit 1
    }
    
    Write-Host ""
    $continue = Read-Host "?? ???? ??????? ????? ?? Hostinger? (y ???????? / n ???????)"
    if ($continue -ne "y") {
        Write-Host "??  ???? - ??? ??????? ???? ???????? ??? ????" -ForegroundColor Yellow
        exit 0
    }
}

# Load environment variables
Write-Host "`n?? ????? ?????????..." -ForegroundColor Yellow
Get-Content $envFile | ForEach-Object {
    if ($_ -match '^([^=]+)=(.*)$') {
        $key = $matches[1].Trim()
        $value = $matches[2].Trim()
        if ($key -notlike "#*") {
            Set-Item -Path "env:$key" -Value $value
        }
    }
}

Write-Host "? ?? ????? ?????????`n" -ForegroundColor Green
Write-Host "   Domain: $env:HOSTINGER_DOMAIN" -ForegroundColor Gray
Write-Host "   SSH: ${env:HOSTINGER_USER}@${env:HOSTINGER_HOST}:${env:HOSTINGER_PORT}" -ForegroundColor Gray
Write-Host "   Path: $env:HOSTINGER_TARGET`n" -ForegroundColor Gray

# Build step
if (-not $SkipBuild) {
    Write-Host "?????????????????????????????????????????????????????" -ForegroundColor DarkGray
    Write-Host "?? ???? ???????..." -ForegroundColor Yellow
    
    Write-Host "   ? pnpm install" -ForegroundColor Gray
    pnpm install --frozen-lockfile 2>&1 | Out-Null
    
    Write-Host "   ? pnpm build" -ForegroundColor Gray
    pnpm run build
    
    if ($LASTEXITCODE -ne 0) {
        Write-Host "? ??? ??????!" -ForegroundColor Red
        exit 1
    }
    Write-Host "? ?? ?????? ?????`n" -ForegroundColor Green
} else {
    Write-Host "??  ?? ???? ?????? (--SkipBuild)`n" -ForegroundColor Yellow
}

# Verify build output
if (-not (Test-Path "dist/index.js")) {
    Write-Host "? ???: dist/index.js ??? ????? - ?? ??????? ?????!" -ForegroundColor Red
    exit 1
}

if ($TestOnly) {
    Write-Host "? ?????? ???? - ?? ?????? (--TestOnly)" -ForegroundColor Green
    exit 0
}

# Prepare deployment package
Write-Host "?????????????????????????????????????????????????????" -ForegroundColor DarkGray
Write-Host "?? ????? ????? ?????..." -ForegroundColor Yellow

$deployDir = "deploy-temp"
if (Test-Path $deployDir) {
    Remove-Item $deployDir -Recurse -Force
}
New-Item -ItemType Directory -Path $deployDir | Out-Null

# Copy required files
Write-Host "   ? ??? dist/" -ForegroundColor Gray
Copy-Item "dist" -Destination "$deployDir\dist" -Recurse

Write-Host "   ? ??? package.json" -ForegroundColor Gray
Copy-Item "package.json" -Destination "$deployDir\"

if (Test-Path "pnpm-lock.yaml") {
    Write-Host "   ? ??? pnpm-lock.yaml" -ForegroundColor Gray
    Copy-Item "pnpm-lock.yaml" -Destination "$deployDir\"
}

# Copy drizzle migrations if they exist
if (Test-Path "drizzle") {
    Write-Host "   ? ??? drizzle/" -ForegroundColor Gray
    Copy-Item "drizzle" -Destination "$deployDir\drizzle" -Recurse
}

# Create production .env
Write-Host "   ? ????? .env ???????" -ForegroundColor Gray
$serverEnv = @"
NODE_ENV=production
PORT=3000
COOKIE_SECRET=$env:COOKIE_SECRET
WEB_ORIGIN=$env:WEB_ORIGIN
VITE_SERVER_ORIGIN=$env:VITE_SERVER_ORIGIN
DATABASE_URL=$env:DATABASE_URL
OAUTH_SERVER_URL=$env:OAUTH_SERVER_URL
VITE_OAUTH_PORTAL_URL=$env:VITE_OAUTH_PORTAL_URL
VITE_APP_ID=$env:VITE_APP_ID
VITE_USE_DEV_LOGIN=false
OWNER_OPEN_ID=$env:OWNER_OPEN_ID
ALLOW_AUTO_PROVISION=$env:ALLOW_AUTO_PROVISION
"@
Set-Content -Path "$deployDir\.env" -Value $serverEnv -Encoding UTF8

Write-Host "? ?? ????? ???????`n" -ForegroundColor Green

# Upload via SSH/SCP
Write-Host "?????????????????????????????????????????????????????" -ForegroundColor DarkGray
Write-Host "?? ??? ??????? ??? Hostinger..." -ForegroundColor Yellow

$sshKey = ".ssh\id_ed25519"
if (-not (Test-Path $sshKey)) {
    Write-Host "? ????? SSH ??? ?????!" -ForegroundColor Red
    exit 1
}

# Test SSH connection first
Write-Host "   ? ?????? ???????..." -ForegroundColor Gray
$testCmd = "ssh -i $sshKey -p $env:HOSTINGER_PORT -o ConnectTimeout=10 -o StrictHostKeyChecking=accept-new ${env:HOSTINGER_USER}@${env:HOSTINGER_HOST} 'echo OK'"
$testResult = Invoke-Expression $testCmd 2>&1

if ($LASTEXITCODE -ne 0) {
    Write-Host "? ??? ??????? ?? Hostinger!" -ForegroundColor Red
    Write-Host "   ???? ??:" -ForegroundColor Yellow
    Write-Host "   - ??????? ????? ???? ?? Hostinger Panel" -ForegroundColor Yellow
    Write-Host "   - SSH Host, User, Port ?????" -ForegroundColor Yellow
    Write-Host "`nError: $testResult" -ForegroundColor Red
    exit 1
}

Write-Host "   ? ??????? ????" -ForegroundColor Green

# Create target directory if not exists
Write-Host "   ? ????? ?????? ?????..." -ForegroundColor Gray
ssh -i $sshKey -p $env:HOSTINGER_PORT "${env:HOSTINGER_USER}@${env:HOSTINGER_HOST}" "mkdir -p $env:HOSTINGER_TARGET"

# Upload files
Write-Host "   ? ??? ??????? (?? ?????? ??? ?????)..." -ForegroundColor Gray
scp -i $sshKey -P $env:HOSTINGER_PORT -r "$deployDir/*" "${env:HOSTINGER_USER}@${env:HOSTINGER_HOST}:$env:HOSTINGER_TARGET/"

if ($LASTEXITCODE -ne 0) {
    Write-Host "? ??? ??? ???????!" -ForegroundColor Red
    exit 1
}

Write-Host "? ?? ??? ??????? ?????`n" -ForegroundColor Green

# Install dependencies and start app
Write-Host "?????????????????????????????????????????????????????" -ForegroundColor DarkGray
Write-Host "?? ????? Dependencies ?????? ???????..." -ForegroundColor Yellow

$sshCommands = @"
cd $env:HOSTINGER_TARGET
echo '? ????? dependencies...'
npm install --production --legacy-peer-deps
echo '? ????? ??????? ?????? ?? ???...'
npx pm2 delete gtd-sys 2>/dev/null || true
echo '? ??? ???????...'
NODE_ENV=production npx pm2 start dist/index.js --name gtd-sys --time
echo '? ??? ??????? PM2...'
npx pm2 save
echo '? ??? ???? ???????...'
npx pm2 list
"@

ssh -i $sshKey -p $env:HOSTINGER_PORT "${env:HOSTINGER_USER}@${env:HOSTINGER_HOST}" $sshCommands

Write-Host "? ?? ????? ???????`n" -ForegroundColor Green

# Health check
Write-Host "?????????????????????????????????????????????????????" -ForegroundColor DarkGray
Write-Host "?? ??? ??? ???????..." -ForegroundColor Yellow
Write-Host "   (?????? 10 ????? ???? ???????...)`n" -ForegroundColor Gray

Start-Sleep -Seconds 10

try {
    $healthUrl = "https://$env:HOSTINGER_DOMAIN/healthz"
    Write-Host "   ? GET $healthUrl" -ForegroundColor Gray
    
    $response = Invoke-WebRequest -Uri $healthUrl -UseBasicParsing -TimeoutSec 15
    
    if ($response.StatusCode -eq 200) {
        Write-Host "? ??????? ???? ?????!" -ForegroundColor Green
        Write-Host "`n   Response:" -ForegroundColor Gray
        Write-Host "   $($response.Content)" -ForegroundColor DarkGray
    }
} catch {
    Write-Host "??  ?? ??? ?????? ??? healthcheck" -ForegroundColor Yellow
    Write-Host "   ????? ???????:" -ForegroundColor Gray
    Write-Host "   - ??????? ????? ??? ???? ?????" -ForegroundColor Gray
    Write-Host "   - SSL ??? ??? ???" -ForegroundColor Gray
    Write-Host "   - Domain ?? ????? ???" -ForegroundColor Gray
    Write-Host "`n   ??? ??????: https://$env:HOSTINGER_DOMAIN/healthz" -ForegroundColor Yellow
    Write-Host "`n   Error: $($_.Exception.Message)" -ForegroundColor Red
}

# Cleanup
Write-Host "`n?????????????????????????????????????????????????????" -ForegroundColor DarkGray
Remove-Item $deployDir -Recurse -Force
Write-Host "?? ?? ??? ????? ????? ???????" -ForegroundColor Gray

# Success summary
Write-Host "`n" -NoNewline
Write-Host "???????????????????????????????????????????????????????" -ForegroundColor Green
Write-Host "  ? ????? ????? ?????!" -ForegroundColor Green
Write-Host "???????????????????????????????????????????????????????" -ForegroundColor Green
Write-Host ""
Write-Host "?? ??????: " -NoNewline -ForegroundColor White
Write-Host "https://$env:HOSTINGER_DOMAIN" -ForegroundColor Cyan
Write-Host ""
Write-Host "?? ?????? ?? Logs:" -ForegroundColor Yellow
Write-Host "   ssh -i $sshKey -p $env:HOSTINGER_PORT ${env:HOSTINGER_USER}@${env:HOSTINGER_HOST}" -ForegroundColor Gray
Write-Host "   npx pm2 logs gtd-sys" -ForegroundColor Gray
Write-Host ""
Write-Host "?? ?????? ???????:" -ForegroundColor Yellow
Write-Host "   ssh ... 'cd $env:HOSTINGER_TARGET && npx pm2 restart gtd-sys'" -ForegroundColor Gray
Write-Host ""
Write-Host "??  ??????? ?????:" -ForegroundColor Red
Write-Host "   - ???? .env.hostinger ??? ????????" -ForegroundColor White
Write-Host "   - ?? ???? .env.hostinger ??? Git" -ForegroundColor White
Write-Host "   - ???? ?? SSL ????? ?? Hostinger Panel" -ForegroundColor White
Write-Host ""
