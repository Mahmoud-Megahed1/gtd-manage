# ?????? ????? ?????? ??? Hostinger
# Quick Deploy to Hostinger

Write-Host "?? GTD System - Hostinger Deployment Script" -ForegroundColor Cyan
Write-Host "============================================`n" -ForegroundColor Cyan

# ?????? ?? ???? ?????? ???????
$envFile = ".env.hostinger"
if (-not (Test-Path $envFile)) {
    Write-Host "??  ??? .env.hostinger ??? ?????" -ForegroundColor Yellow
    Write-Host "????? ??????? ????...`n" -ForegroundColor Yellow
    
    Write-Host "???? ??????? Hostinger:" -ForegroundColor White
    $host_ssh = Read-Host "SSH Host (????: srv123.hostinger.com)"
    $host_user = Read-Host "SSH Username (????: u123456789)"
    $host_port = Read-Host "SSH Port (???? 65002)"
    $host_path = Read-Host "Target Path (????: /home/u123456789/domains/yourdomain.com/public_html)"
    $domain = Read-Host "Domain (????: yourdomain.com)"
    
    Write-Host "`n??????? Database:" -ForegroundColor White
    $db_name = Read-Host "Database Name"
    $db_user = Read-Host "Database User"
    $db_pass = Read-Host "Database Password" -AsSecureString
    $db_pass_plain = [Runtime.InteropServices.Marshal]::PtrToStringAuto([Runtime.InteropServices.Marshal]::SecureStringToBSTR($db_pass))
    
    Write-Host "`n??????? OAuth (???? Enter ??????):" -ForegroundColor White
    $oauth_url = Read-Host "OAuth Server URL"
    $oauth_portal = Read-Host "OAuth Portal URL"
    $app_id = Read-Host "App ID"
    
    # ????? COOKIE_SECRET ?????? ???
    $cookie_secret = -join ((1..32) | ForEach-Object { '{0:x}' -f (Get-Random -Max 256) })
    
    $envContent = @"
# Hostinger Connection
HOSTINGER_HOST=$host_ssh
HOSTINGER_USER=$host_user
HOSTINGER_PORT=$host_port
HOSTINGER_TARGET=$host_path
HOSTINGER_DOMAIN=$domain

# Production Environment
NODE_ENV=production
PORT=3000
COOKIE_SECRET=$cookie_secret
WEB_ORIGIN=https://$domain
VITE_SERVER_ORIGIN=https://$domain
DATABASE_URL=mysql://${db_user}:${db_pass_plain}@localhost:3306/$db_name
OAUTH_SERVER_URL=$oauth_url
VITE_OAUTH_PORTAL_URL=$oauth_portal
VITE_APP_ID=$app_id
VITE_USE_DEV_LOGIN=false
"@
    
    Set-Content -Path $envFile -Value $envContent
    Write-Host "? ?? ????? ??? .env.hostinger" -ForegroundColor Green
    Write-Host "??  ???? ??? ????? ??? ????? ?????? ?????!`n" -ForegroundColor Yellow
}

# ????? ?????????
Get-Content $envFile | ForEach-Object {
    if ($_ -match '^([^=]+)=(.*)$') {
        $key = $matches[1].Trim()
        $value = $matches[2].Trim()
        Set-Item -Path "env:$key" -Value $value
    }
}

Write-Host "?? ???? 1: ???? ???????..." -ForegroundColor Yellow
pnpm run build
if ($LASTEXITCODE -ne 0) {
    Write-Host "? ??? ??????!" -ForegroundColor Red
    exit 1
}
Write-Host "? ?? ?????? ?????`n" -ForegroundColor Green

Write-Host "?? ???? 2: ??? ??????? ??? SSH..." -ForegroundColor Yellow
$sshKey = ".ssh\id_ed25519"
if (-not (Test-Path $sshKey)) {
    Write-Host "? ????? SSH ??? ????? ?? .ssh\id_ed25519" -ForegroundColor Red
    Write-Host "?? ?????? ????? SSH ?????: ssh-keygen -t ed25519 -C 'hostinger-deploy'" -ForegroundColor Yellow
    exit 1
}

# ?????? ?? ????? ??????? ????? ?? Hostinger
Write-Host "`n??????? ????? ??? SSH (???? ?? Hostinger Panel > SSH Keys):" -ForegroundColor Cyan
Get-Content ".ssh\id_ed25519.pub"
Write-Host ""
$continue = Read-Host "?? ?? ????? ??????? ????? ?? Hostinger? (y/n)"
if ($continue -ne "y") {
    Write-Host "??  ??? ??????? ????? ?? Hostinger ????? ?? ???? ??? ????" -ForegroundColor Yellow
    exit 0
}

# ????? ???? ???? ?????
$deployDir = "deploy-temp"
if (Test-Path $deployDir) {
    Remove-Item $deployDir -Recurse -Force
}
New-Item -ItemType Directory -Path $deployDir | Out-Null

# ??? ??????? ????????
Write-Host "?? ??? ???????..." -ForegroundColor Yellow
Copy-Item "dist" -Destination "$deployDir\dist" -Recurse
Copy-Item "package.json" -Destination "$deployDir\"
Copy-Item "pnpm-lock.yaml" -Destination "$deployDir\" -ErrorAction SilentlyContinue

# ????? ??? .env ???????
$serverEnv = @"
NODE_ENV=$env:NODE_ENV
PORT=$env:PORT
COOKIE_SECRET=$env:COOKIE_SECRET
WEB_ORIGIN=$env:WEB_ORIGIN
VITE_SERVER_ORIGIN=$env:VITE_SERVER_ORIGIN
DATABASE_URL=$env:DATABASE_URL
OAUTH_SERVER_URL=$env:OAUTH_SERVER_URL
VITE_OAUTH_PORTAL_URL=$env:VITE_OAUTH_PORTAL_URL
VITE_APP_ID=$env:VITE_APP_ID
VITE_USE_DEV_LOGIN=$env:VITE_USE_DEV_LOGIN
"@
Set-Content -Path "$deployDir\.env" -Value $serverEnv

# ??? ??? SCP
Write-Host "?? ??????? ?? Hostinger..." -ForegroundColor Yellow
$scpCommand = "scp -i $sshKey -P $env:HOSTINGER_PORT -r $deployDir/* ${env:HOSTINGER_USER}@${env:HOSTINGER_HOST}:$env:HOSTINGER_TARGET"
Write-Host "Command: $scpCommand" -ForegroundColor Gray
Invoke-Expression $scpCommand

if ($LASTEXITCODE -ne 0) {
    Write-Host "? ??? ??? ???????!" -ForegroundColor Red
    exit 1
}
Write-Host "? ?? ??? ???????`n" -ForegroundColor Green

Write-Host "?? ???? 3: ????? Dependencies ?????? ???????..." -ForegroundColor Yellow
$sshCommand = @"
cd $env:HOSTINGER_TARGET && \
npm install --production && \
npx pm2 delete gtd-sys 2>/dev/null || true && \
NODE_ENV=production npx pm2 start dist/index.js --name gtd-sys && \
npx pm2 save
"@

ssh -i $sshKey -p $env:HOSTINGER_PORT "${env:HOSTINGER_USER}@${env:HOSTINGER_HOST}" $sshCommand

if ($LASTEXITCODE -ne 0) {
    Write-Host "??  ?? ???? ???? ????? ?? ???????" -ForegroundColor Yellow
}

Write-Host "`n?? ???? 4: ??? ?????..." -ForegroundColor Yellow
Start-Sleep -Seconds 5
try {
    $response = Invoke-WebRequest -Uri "https://$env:HOSTINGER_DOMAIN/healthz" -UseBasicParsing
    if ($response.StatusCode -eq 200) {
        Write-Host "? ??????? ???? ?????!" -ForegroundColor Green
        Write-Host "Response: $($response.Content)" -ForegroundColor Gray
    }
} catch {
    Write-Host "??  ??? ??? ????? - ???? ?? Logs ?? Hostinger" -ForegroundColor Yellow
    Write-Host "Error: $_" -ForegroundColor Gray
}

# ?????
Remove-Item $deployDir -Recurse -Force

Write-Host "`n? ????? ?????!" -ForegroundColor Green
Write-Host "?? ??????: https://$env:HOSTINGER_DOMAIN" -ForegroundColor Cyan
Write-Host "`n?????? ?? Logs:" -ForegroundColor Yellow
Write-Host "ssh -i $sshKey -p $env:HOSTINGER_PORT ${env:HOSTINGER_USER}@${env:HOSTINGER_HOST}" -ForegroundColor Gray
Write-Host "npx pm2 logs gtd-sys" -ForegroundColor Gray

Write-Host "`n??  ?? ???? ??? ??? .env.hostinger ?????? ?????!" -ForegroundColor Red
