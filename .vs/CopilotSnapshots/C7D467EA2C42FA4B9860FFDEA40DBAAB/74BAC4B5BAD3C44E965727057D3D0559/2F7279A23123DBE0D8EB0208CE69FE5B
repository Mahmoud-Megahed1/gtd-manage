#!/usr/bin/env pwsh
# Simple Deploy - No fancy stuff, just works!
# رفع بسيط - بدون تعقيدات، فقط يعمل!

$ErrorActionPreference = "Stop"

Write-Host @"

╔═══════════════════════════════════════════════════════════════╗
║                  🚀 Simple Deploy to Hostinger                ║
╚═══════════════════════════════════════════════════════════════╝

"@ -ForegroundColor Cyan

# الخطوة 1: جمع البيانات
Write-Host "📝 يرجى إدخال بيانات Hostinger:`n" -ForegroundColor Yellow

$host_ssh = Read-Host "SSH Host (مثال: srv123.hostinger.com)"
$host_user = Read-Host "SSH Username (مثال: u123456789)"
$host_port = Read-Host "SSH Port (اضغط Enter للافتراضي: 65002)"
if (!$host_port) { $host_port = "65002" }

$domain = Read-Host "Domain Name (مثال: gtd-sys.com)"
$target = "/home/$host_user/domains/$domain/public_html"
Write-Host "Target Path: $target" -ForegroundColor Gray

Write-Host "`n💾 بيانات Database:`n" -ForegroundColor Yellow
$db_name = Read-Host "Database Name"
$db_user = Read-Host "Database User"
$db_pass = Read-Host "Database Password" -AsSecureString
$db_pass_plain = [Runtime.InteropServices.Marshal]::PtrToStringAuto(
    [Runtime.InteropServices.Marshal]::SecureStringToBSTR($db_pass)
)

# توليد COOKIE_SECRET
$cookie_secret = -join ((1..48) | ForEach-Object { [char](Get-Random -Min 33 -Max 126) })

# الخطوة 2: Build
Write-Host "`n⚙️  بناء المشروع..." -ForegroundColor Yellow
pnpm run build
if ($LASTEXITCODE -ne 0) {
    Write-Host "❌ فشل البناء!" -ForegroundColor Red
    exit 1
}
Write-Host "✅ تم البناء" -ForegroundColor Green

# الخطوة 3: تجهيز الملفات
Write-Host "`n📦 تجهيز الملفات..." -ForegroundColor Yellow
$temp = "deploy-pkg"
if (Test-Path $temp) { Remove-Item $temp -Recurse -Force }
New-Item $temp -ItemType Directory | Out-Null

Copy-Item "dist" "$temp\dist" -Recurse
Copy-Item "package.json" "$temp\"
if (Test-Path "pnpm-lock.yaml") { Copy-Item "pnpm-lock.yaml" "$temp\" }

# إنشاء .env
@"
NODE_ENV=production
PORT=3000
COOKIE_SECRET=$cookie_secret
WEB_ORIGIN=https://$domain
VITE_SERVER_ORIGIN=https://$domain
DATABASE_URL=mysql://${db_user}:${db_pass_plain}@localhost:3306/$db_name
VITE_APP_ID=gtd-prod
VITE_USE_DEV_LOGIN=false
VITE_ANALYTICS_ENDPOINT=
VITE_ANALYTICS_WEBSITE_ID=
"@ | Set-Content "$temp\.env"

Write-Host "✅ الملفات جاهزة" -ForegroundColor Green

# الخطوة 4: اختبار SSH
Write-Host "`n🔌 اختبار SSH..." -ForegroundColor Yellow
$ssh_key = ".ssh\id_ed25519"

if (!(Test-Path $ssh_key)) {
    Write-Host "❌ SSH Key غير موجود!" -ForegroundColor Red
    Write-Host "   شغّل: ssh-keygen -t ed25519 -f $ssh_key" -ForegroundColor Yellow
    exit 1
}

$test = ssh -i $ssh_key -p $host_port -o ConnectTimeout=10 ${host_user}@${host_ssh} "echo OK" 2>&1
if ($LASTEXITCODE -ne 0) {
    Write-Host "❌ فشل SSH!" -ForegroundColor Red
    Write-Host "   تأكد من إضافة SSH Public Key في Hostinger" -ForegroundColor Yellow
    exit 1
}
Write-Host "✅ SSH يعمل" -ForegroundColor Green

# الخطوة 5: الرفع
Write-Host "`n📤 رفع الملفات..." -ForegroundColor Yellow
ssh -i $ssh_key -p $host_port ${host_user}@${host_ssh} "mkdir -p $target"
scp -i $ssh_key -P $host_port -r "$temp/*" ${host_user}@${host_ssh}:$target/

if ($LASTEXITCODE -ne 0) {
    Write-Host "❌ فشل الرفع!" -ForegroundColor Red
    exit 1
}
Write-Host "✅ تم الرفع" -ForegroundColor Green

# الخطوة 6: تشغيل
Write-Host "`n🚀 تشغيل التطبيق..." -ForegroundColor Yellow
ssh -i $ssh_key -p $host_port ${host_user}@${host_ssh} @"
cd $target
npm install --production --silent
npx pm2 delete gtd-sys 2>/dev/null || true
NODE_ENV=production npx pm2 start dist/index.js --name gtd-sys
npx pm2 save
npx pm2 list
"@

Write-Host "✅ التطبيق يعمل!" -ForegroundColor Green

# الخطوة 7: اختبار
Write-Host "`n🧪 اختبار الموقع..." -ForegroundColor Yellow
Start-Sleep 5

try {
    $res = Invoke-WebRequest "https://$domain/healthz" -TimeoutSec 10
    if ($res.StatusCode -eq 200) {
        Write-Host "✅ الموقع يعمل!" -ForegroundColor Green
    }
} catch {
    Write-Host "⚠️  لم يتم الاتصال - جرب يدوياً" -ForegroundColor Yellow
}

# تنظيف
Remove-Item $temp -Recurse -Force

# النتيجة
Write-Host @"

╔═══════════════════════════════════════════════════════════════╗
║                     ✅ تم الرفع بنجاح!                       ║
╚═══════════════════════════════════════════════════════════════╝

🌐 الموقع: https://$domain
📊 Health: https://$domain/healthz

📝 أوامر مفيدة:
   ssh -i $ssh_key -p $host_port ${host_user}@${host_ssh}
   npx pm2 logs gtd-sys
   npx pm2 restart gtd-sys

"@ -ForegroundColor Green
